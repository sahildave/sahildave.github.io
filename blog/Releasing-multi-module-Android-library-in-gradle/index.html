<!doctype html> <title>Multi-module Android library - Sahil Dave</title> <meta name=viewport content="width=device-width,initial-scale=1,viewport-fit=cover"> <meta name=description content="In the last post I had discussed how we are using product flavors to release different versions of the code base with minor changes. It had helped us serve different clients with different requirements. In this post I would share..."> <meta name=theme-color content=#00bcd4> <link rel=alternate href=/feed.xml type=application/atom+xml> <link rel=apple-touch-icon href=/apple-touch-icon.png> <link rel=icon href=/favicon.png type=image/png> <link rel=icon href="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='196' height='196' viewBox='0 0 196 196'>  <path fill-rule='evenodd' stroke='#000' stroke-width='9' d='M88.176,57.836 L77.211,70.994 C74.373,66.092 70.245,62.996 63.924,62.996 C57.861,62.996 51.282,67.64 50.25,73.961 C47.67,90.344 87.402,83.507 82.242,116.144 C79.146,135.623 64.827,149.426 44.961,149.426 C31.545,149.426 22.902,141.686 18,130.463 L32.19,118.466 C33.609,125.948 39.285,132.656 47.412,132.656 C55.152,132.656 61.086,126.077 62.247,118.595 C63.795,108.533 55.023,105.695 47.799,102.728 C36.189,97.568 27.933,91.247 30.384,76.154 C32.964,60.029 47.025,47 63.408,47 C72.051,47 83.274,51.257 88.176,57.836 Z M95.2919095,146.846 L110.642909,49.58 L137.732909,49.58 C165.854909,49.58 181.463909,70.607 177.077909,98.342 C172.691909,125.69 149.987909,146.846 122.252909,146.846 L95.2919095,146.846 Z M127.025909,66.092 L116.834909,130.334 L119.930909,130.334 C143.279909,130.334 154.373909,117.434 157.469909,98.213 C160.823909,77.057 151.664909,66.092 130.121909,66.092 L127.025909,66.092 Z'/></svg>" sizes=any type=image/svg+xml> <link rel=mask-icon href=/mask-icon.svg color=#00bcd4> <link rel=manifest href=/manifest.json> <style>*,:after,:before{padding:0;margin:0;box-sizing:border-box}html{font-size:100%;-webkit-text-size-adjust:none;-moz-text-size-adjust:none;-ms-text-size-adjust:none;text-size-adjust:none;text-rendering:optimizelegibility;image-rendering:optimizequality;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;background:#fff}body{padding:0 24vw;margin:0 auto 0;font-family:-apple-system,BlinkMacSystemFont,"Helvetica Neue",Arial,sans-serif;font-size:1.6vw;line-height:1.42857143;hanging-punctuation:first allow-end;color:#000;background:#fff;transition:all .2s ease}@media (max-width:2560px){body{padding-left:24vw;padding-right:24vw;font-size:.8vw}}@media (max-width:1440px){body{padding-left:24vw;padding-right:24vw;font-size:1.28vw}}@media (max-width:1020px){body{padding-left:8vw;padding-right:8vw;font-size:2.24vw}}@media (max-width:640px){body{padding-left:4vw;padding-right:4vw;font-size:3.84vw}}@media (max-width:400px){body{font-size:5.12vw}}a{color:#000;text-decoration:none;transition:color .5s ease,border-color .5s ease,background .5s ease,opacity 1.5s ease}a:focus,a:hover{transition:color .1s ease,border-color .1s ease,background .1s ease,opacity .1s ease;text-decoration:underline;-webkit-text-decoration-skip:ink;text-decoration-skip:ink}hr,img{border:0}::-webkit-input-placeholder{color:#000;opacity:.2}:-ms-input-placeholder{color:#000;opacity:.2}::-ms-input-placeholder{color:#000;opacity:.2}:focus::-webkit-input-placeholder{color:#00bcd4}:focus:-ms-input-placeholder{color:#00bcd4}:focus::-ms-input-placeholder{color:#00bcd4}.js-system--apple{-webkit-font-feature-settings:"case","ss01","ss02";font-feature-settings:"case","ss01","ss02"}.navigation{padding-top:1.4vmax;padding-bottom:1.4vmax;margin-right:-1vmax;margin-left:-1vmax;font-size:60%;font-weight:700;letter-spacing:.45em;text-transform:uppercase}.navigation li{display:inline-block;line-height:2;list-style:none}.navigation li a{padding:.5em 1vmax}.navigation li a:focus,.navigation li a:hover{color:#00bcd4;text-decoration:none}.content{margin-bottom:8vmin}.content:after,.content:before{display:table;content:""}.content:after{clear:both}.content article>:last-child{margin-bottom:0!important}.content article>:last-child>:last-child{margin-bottom:0!important}.content article>:last-child>:last-child>:last-child{margin-bottom:0!important}.content article>:last-child>:last-child>:last-child>:last-child{margin-bottom:0!important}.content .post-content>:first-child{margin-top:0}.content a{font-weight:700}.content a:has(>code){-webkit-text-decoration-color:#00cc80;text-decoration-color:#00cc80}.content p{margin-bottom:1.6rem;line-height:1.71428571}.content header{display:-webkit-box;display:flex;padding-top:10vmin;padding-bottom:10vmin;margin-bottom:8vmin;-webkit-box-orient:vertical;-webkit-box-direction:normal;flex-direction:column;-webkit-box-pack:center;justify-content:center;background:rgba(0,0,0,.02);padding-left:24vw;padding-right:24vw;margin-left:-24vw;margin-right:-24vw}@media (max-width:1020px){.content header{min-height:calc(50vh - 1.4vmax * 2 - 3ex);padding-top:16vmin;padding-bottom:8vmin;padding-left:8vw;padding-right:8vw;margin-left:-8vw;margin-right:-8vw}}@media (max-width:640px){.content header{padding-left:4vw;padding-right:4vw;margin-left:-4vw;margin-right:-4vw}}.content header h1{font-size:360%;font-weight:700;letter-spacing:-.04em;margin-left:-2px;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none;line-height:1.1}@media (max-width:640px){.content header h1{font-size:280%}}.content header small{display:block;margin-top:2vmin}.content h2,.content h3{margin:10vmin 0 1rem;font-size:72%;font-weight:400;opacity:.5}.content ul{margin-bottom:1.8rem;list-style:none;counter-reset:list}@media (max-width:640px){.content ul{margin-left:1em}}.content ul li{line-height:1.71428571}.content ul li:before{position:absolute;display:inline-block;width:4em;margin-top:1px;margin-left:-4em;font-size:80%;line-height:2.14285714;text-align:right;opacity:.6;pointer-events:none}.content ul li:before{content:"â€¢";padding-right:.6em}.content img{display:block;width:calc(100% + (8vw * 2));margin:0 0 0}@media (max-width:1020px){.content img{width:calc(100% + (8vw * 2));margin-left:-8vw;margin-right:-8vw}}@media (max-width:640px){.content img{width:calc(100% + (4vw * 2));margin-left:-4vw;margin-right:-4vw}}.content hr::before{display:block;content:'';width:3px;height:3px;margin:2em auto;border-radius:50%;background:#000;box-shadow:24px 0 0 0 #000,-24px 0 0 0 #000}.content code,.content pre{font-family:Menlo,Consolas,monospace;color:#00cc80}.content pre{background:rgba(0,136,255,.04)}.content code{font-size:92%;overflow-wrap:break-word}.content .highlight>pre,.content .highlighter-rouge pre.highlight,.content pre{padding:1.2vw;margin-left:-1.2vw;margin-right:-1.2vw;margin-bottom:1.8rem;overflow-x:auto;font-size:80%;line-height:1.71428571;-webkit-overflow-scrolling:touch}@media (max-width:1020px){.content .highlight>pre,.content .highlighter-rouge pre.highlight,.content pre{padding-left:8vw;padding-right:8vw;margin-left:-8vw;margin-right:-8vw}}@media (max-width:640px){.content .highlight>pre,.content .highlighter-rouge pre.highlight,.content pre{padding-left:4vw;padding-right:4vw;margin-left:-4vw;margin-right:-4vw}}.content .highlight>pre code,.content .highlighter-rouge pre.highlight code,.content pre code{overflow-wrap:normal}.post-modified-date{font-size:75%;opacity:.5}.footer{padding:8vmin 0 4vmin;font-size:75%;text-transform:lowercase}.footer ul li{display:inline}.footer ul li:after{padding:0 1vmax;content:" / ";opacity:.3}.footer ul li:last-child:after{content:none}@media print{*,:after,:before{background:0 0!important;color:#000!important;box-shadow:none!important;text-shadow:none!important}body{padding:10mm!important;margin:0!important}a,a:visited{text-decoration:none}.content header{min-height:0;padding-bottom:0}.content .post-content{max-width:100%!important}.content .post-content a[href]:after{content:" (" attr(href) ")";font-weight:400}pre{page-break-inside:avoid}img{page-break-inside:avoid}img{max-width:100%!important}h2,h3,p{orphans:3;widows:3}h2,h3{page-break-after:avoid}.footer,.navigation{display:none}}.highlight>pre,.highlighter-rouge pre.highlight{background:rgba(0,56,64,.02)}.highlight code,.highlighter-rouge code{color:#656e6f}.highlight .c,.highlighter-rouge .c{font-style:italic}.highlight .cp,.highlighter-rouge .cp{font-weight:700}.highlight .o,.highlighter-rouge .o{font-weight:700}.highlight .k,.highlighter-rouge .k{font-weight:700}.highlight .n,.highlighter-rouge .n{color:#00c9bd}.highlight .na,.highlighter-rouge .na{color:#00c9cb}.highlight .nl,.highlighter-rouge .nl{color:#0048ce}.highlight .nt,.highlighter-rouge .nt{color:#0a26ce}.highlight .k,.highlighter-rouge .k{color:#a3266f}.highlight .s,.highlighter-rouge .s{color:#a3822a}.highlight .s2,.highlighter-rouge .s2{color:#a3bd2a}.highlight .o,.highlighter-rouge .o{color:#00c965}.highlight .c,.highlighter-rouge .c{color:#40688d;opacity:.6}.highlight .cp,.highlighter-rouge .cp{color:#777655;opacity:.6}</style> <link rel=canonical href=https://in-sahildave.github.com/blog/Releasing-multi-module-Android-library-in-gradle/ > <meta property=og:type content=article> <meta property=og:site_name content="Sahil Dave"> <meta property=og:title content="Multi-module Android library"> <meta property=og:url content=https://in-sahildave.github.com/blog/Releasing-multi-module-Android-library-in-gradle/ > <meta property=og:description content="In the last post I had discussed how we are using product flavors to release different versions of the code base with minor changes. It had helped us serve different clients with different requirements. In this post I would share..."> <meta property=og:image content=/assets/images/multi_library.png> <meta name=twitter:card content=summary_large_image> <meta name=twitter:site content=@sahildave1991> <meta name=twitter:creator content=@sahildave1991> <meta property=article:published_time content=2017-01-23T00:00:00+01:00> <meta property=article:modified_time content=2018-06-13T10:21:12+02:00> <meta name=twitter:label1 value=Words> <meta name=twitter:data1 value="520 words"> <meta name=twitter:label2 value="Reading time"> <meta name=twitter:data2 value="2 mins"> <nav class=navigation> <ul> <li> <a href=/ > Home </a> </li> <li> <a href=/work/ > Work </a> </li> <li> <a href=/blog/ > Blog </a> </li> <li> <a href=/assets/cv.pdf target=_blank> Resume </a> </li> </ul> </nav> <main class=content role=main> <article> <header> <h1 title="Multi-module Android library" data-title="Multi-module Android library"> Multi-module Android library<span class="dot dot--post"> </span> </h1> <small>In this post I would share how we release multiple split libraries and have interdependencies similar to how Google releases play-services or appcompat libraries.</small> </header> <div class=post-content> <p>In the last post I had discussed how we are using product flavors to release different versions of the code base with minor changes. It had helped us serve different clients with different requirements. In this post I would share how we release multiple split libraries and have interdependencies similar to how Google releases play-services or appcompat libraries. It seems easy till the publishing day, until it is not! The problem with inter-dependency is maven does not add the version number in the pom file for local module dependencies.</p> <p><img src=/assets/images/multi_library.png alt="Dependency Tree: Release Libraries are public libraries which are released using Maven."></p> <h2 id=problem>Problem</h2> <p>The problem arises when you try to release the super-library and its pom file includes an <code class=highlighter-rouge>unspecified</code> version number for the core-library in the dependency node.</p> <div class="language-xml highlighter-rouge"><div class=highlight><pre class=highlight><code><span class=cp>&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class=nt>&lt;project</span> <span class=na>xsi:schemaLocation=</span><span class=s>"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd"</span> <span class=na>xmlns=</span><span class=s>"http://maven.apache.org/POM/4.0.0"</span>
    <span class=na>xmlns:xsi=</span><span class=s>"http://www.w3.org/2001/XMLSchema-instance"</span><span class=nt>&gt;</span>
  <span class=nt>&lt;modelVersion&gt;</span>4.0.0<span class=nt>&lt;/modelVersion&gt;</span>
  <span class=nt>&lt;groupId&gt;</span>lib-groupId<span class=nt>&lt;/groupId&gt;</span>
  <span class=nt>&lt;artifactId&gt;</span>lib-artifactId<span class=nt>&lt;/artifactId&gt;</span>
  <span class=nt>&lt;version&gt;</span>0.0.1<span class=nt>&lt;/version&gt;</span>
  <span class=nt>&lt;packaging&gt;</span>aar<span class=nt>&lt;/packaging&gt;</span>
  <span class=nt>&lt;dependencies&gt;</span>
    <span class=nt>&lt;dependency&gt;</span>
      <span class=nt>&lt;groupId&gt;</span>com.android.support<span class=nt>&lt;/groupId&gt;</span>
      <span class=nt>&lt;artifactId&gt;</span>appcompat-v7<span class=nt>&lt;/artifactId&gt;</span>
      <span class=nt>&lt;version&gt;</span>25.1.0<span class=nt>&lt;/version&gt;</span>
      <span class=nt>&lt;scope&gt;</span>compile<span class=nt>&lt;/scope&gt;</span>
    <span class=nt>&lt;/dependency&gt;</span>
    <span class=c>&lt;!-- Highlighted --&gt;</span>
    <span class=nt>&lt;dependency&gt;</span>
      <span class=nt>&lt;groupId&gt;</span>MultiLibrary<span class=nt>&lt;/groupId&gt;</span>
      <span class=nt>&lt;artifactId&gt;</span>core-library<span class=nt>&lt;/artifactId&gt;</span>
      <span class=nt>&lt;version&gt;</span>unspecified<span class=nt>&lt;/version&gt;</span>
      <span class=nt>&lt;scope&gt;</span>compile<span class=nt>&lt;/scope&gt;</span>
    <span class=nt>&lt;/dependency&gt;</span>
    <span class=c>&lt;!-- Highlighted --&gt;</span>
  <span class=nt>&lt;/dependencies&gt;</span>
<span class=nt>&lt;/project&gt;</span>
</code></pre></div></div> <h3 id=highlighted-above>Highlighted above:</h3> <ul> <li><strong>groupId</strong> is the rootProject of the library. Here the repo name MultiLibrary.</li> <li><strong>version</strong> is <code class=highlighter-rouge>unspecified</code></li> </ul> <p>When the client adds it in the their dependencies list, it wont compile throwing an error:</p> <div class=highlighter-rouge><div class=highlight><pre class=highlight><code>Failed to resolve: MultiLibrary.core-library:unspecified
</code></pre></div></div> <h2 id=solution>Solution</h2> <p>We can inject a function just after pom evaluation is done. We would go through each dependency added in the pom file and edit the particular dependency node if its version is <code class=highlighter-rouge>unspecified</code>. You should check for both, <code class=highlighter-rouge>groupId</code> and <code class=highlighter-rouge>version</code>.</p> <div class="language-groovy highlighter-rouge"><div class=highlight><pre class=highlight><code><span class=n>uploadArchives</span> <span class=o>{</span>
    <span class=n>repositories</span> <span class=o>{</span>
        <span class=n>mavenDeployer</span> <span class=o>{</span>
            <span class=n>repository</span><span class=o>(</span><span class=nl>url:</span> <span class=s2>"file://${buildDir}/outputs/maven"</span><span class=o>)</span>
            <span class=n>pom</span><span class=o>.</span><span class=na>groupId</span> <span class=o>=</span> <span class=n>GROUP</span>
            <span class=n>pom</span><span class=o>.</span><span class=na>artifactId</span> <span class=o>=</span> <span class=n>ARTIFACT_ID</span>
            <span class=n>pom</span><span class=o>.</span><span class=na>version</span> <span class=o>=</span> <span class=n>VERSION</span>
            <span class=n>pom</span><span class=o>.</span><span class=na>whenConfigured</span> <span class=o>{</span> <span class=n>pom</span> <span class=o>-&gt;</span>
                <span class=n>println</span><span class=o>(</span><span class=s2>"Current Dependencies ${pom.dependencies}"</span><span class=o>)</span>
                <span class=n>pom</span><span class=o>.</span><span class=na>dependencies</span><span class=o>.</span><span class=na>each</span> <span class=o>{</span> <span class=n>dep</span> <span class=o>-&gt;</span>
                    <span class=n>println</span><span class=o>(</span><span class=s2>"Processing ${dep}"</span><span class=o>)</span>
                    <span class=k>if</span> <span class=o>(</span><span class=n>dep</span><span class=o>.</span><span class=na>getVersion</span><span class=o>()</span> <span class=o>==</span> <span class=s2>"unspecified"</span> <span class=o>&amp;&amp;</span> <span class=n>dep</span><span class=o>.</span><span class=na>getGroupId</span><span class=o>()</span> <span class=o>==</span> <span class=n>rootProjectDir</span><span class=o>)</span> <span class=o>{</span>
                        <span class=n>println</span><span class=o>(</span><span class=s2>"Updating Dependencies"</span><span class=o>)</span>
                        <span class=n>dep</span><span class=o>.</span><span class=na>setGroupId</span><span class=o>(</span><span class=n>GROUP</span><span class=o>)</span>
                        <span class=n>dep</span><span class=o>.</span><span class=na>setVersion</span><span class=o>(</span><span class=n>VERSION</span><span class=o>)</span>
                        <span class=n>println</span><span class=o>(</span><span class=s2>"Updated ${dep}"</span><span class=o>)</span>
                    <span class=o>}</span>
                <span class=o>}</span>
            <span class=o>}</span>
        <span class=o>}</span>
    <span class=o>}</span>
<span class=o>}</span>
</code></pre></div></div> <p>Now the <code class=highlighter-rouge>core-library</code> dependency in the pom file looks like:</p> <div class="language-xml highlighter-rouge"><div class=highlight><pre class=highlight><code><span class=nt>&lt;dependency&gt;</span>
  <span class=nt>&lt;groupId&gt;</span>lib-groupId<span class=nt>&lt;/groupId&gt;</span>
  <span class=nt>&lt;artifactId&gt;</span>core-library<span class=nt>&lt;/artifactId&gt;</span>
  <span class=nt>&lt;version&gt;</span>0.0.1<span class=nt>&lt;/version&gt;</span>
  <span class=nt>&lt;scope&gt;</span>compile<span class=nt>&lt;/scope&gt;</span>
<span class=nt>&lt;/dependency&gt;</span>
</code></pre></div></div> <p>Now the dependency is release ready and the client can integrate the super library. Also the sub libraries can be released as separate modules.</p> <hr> <p>This post originally appear <a href=https://android.jlelse.eu/releasing-multi-module-android-library-in-gradle-7286cd667b4b>here</a> on Medium</p> <footer class=post-modified-date> <p> Updated <time datetime=" 2018-06-13T10:21:12+08:00 "> Wednesday, Jun 13, 2018 </time> </p> </footer> </div> </article> </main> <footer class=footer> <ul> <li><a href=/ >Sahil Dave</a></li> <li><a href=https://dribbble.com/sahildave title=dribbble target=_blank>dribbble</a></li> <li><a href=https://www.behance.net/sahildave title=behance target=_blank>behance</a></li> <li><a href=https://www.linkedin.com/in/sahildave1991/ title=linkedin target=_blank>linkedin</a></li> <li><a href=https://twitter.com/sahildave1991 title=twitter target=_blank>twitter</a></li> <li><a href=mailto:sahildave1991@gmail.com title=mail target=_blank>contact</a></li> </ul> </footer> <script>navigator.platform.match(/(Mac|iPhone|iPod|iPad)/i)&&document.body.classList.add("js-system--apple")</script> <script></script> <script>"serviceWorker"in navigator&&"in-sahildave.github.com"===window.location.hostname&&navigator.serviceWorker.register("/service-worker.js").then(function(e){console.log("ServiceWorker registration successful with scope: ",e.scope)}).catch(function(e){console.log("ServiceWorker registration failed: ",e)})</script> <script async src="https://www.googletagmanager.com/gtag/js?id=UA-56407221-3"></script> <script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","UA-56407221-3")</script>