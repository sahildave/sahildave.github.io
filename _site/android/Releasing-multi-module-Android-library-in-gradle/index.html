<!DOCTYPE html>
<!--
	Forty by HTML5 UP
	html5up.net | @ajlkn
	Free for personal and commercial use under the CCA 3.0 license (html5up.net/license)
-->
<html>

<head>
	<title>Sahil Dave</title>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />

	<link rel="apple-touch-icon" sizes="180x180" href="/assets/favicon/apple-touch-icon.png">
	<link rel="icon" type="image/png" sizes="32x32" href="/assets/favicon/favicon-32x32.png">
	<link rel="icon" type="image/png" sizes="16x16" href="/assets/favicon/favicon-16x16.png">
	<link rel="manifest" href="/assets/favicon/manifest.json">
	<link rel="mask-icon" href="/assets/favicon/safari-pinned-tab.svg" color="#5bbad5">
	<link rel="shortcut icon" href="/assets/favicon/favicon.ico">
	<meta name="msapplication-config" content="/assets/favicon/browserconfig.xml">
	<meta name="theme-color" content="#ffffff">

		<!--[if lte IE 8]><script src="/assets/js/ie/html5shiv.js"></script><![endif]-->
	<link rel="stylesheet" href="/assets/css/main.css" />
	<!--[if lte IE 9]><link rel="stylesheet" href="/assets/css/ie9.css" /><![endif]-->
	<!--[if lte IE 8]><link rel="stylesheet" href="/assets/css/ie8.css" /><![endif]-->
</head>


<body>
<!-- Wrapper -->
<div id="wrapper">

<!-- Header -->
<header id="header">
	<a href="/" class="logo"><strong>Sahil Dave</strong> <span></span></a>
	<nav>
		<a href="#menu">Menu</a>
	</nav>
</header>

<!-- Menu -->
<nav id="menu">
	<ul class="links">
        
		    
		
		    
		
		    
		        <li><a href="/">Home</a></li>
	    	
		
		    
		
		
		    
		        <li><a href="/android.html">Android</a></li>
		    
		
		    
		        <li><a href="/design.html">Design</a></li>
		    
		
		    
		
		    
		
	</ul>
	<ul class="actions vertical">
		<li><a href="mailto:sahildave1991@gmail.com" class="button fit">Contact Me</a></li>
	</ul>
</nav>

<!-- Main -->
<div id="main" class="alt">

<!-- One -->
<section id="one">
	<div class="inner">
		<header class="major">
			<h1>Releasing multi-module Android library in gradle</h1>
		</header>
		
		<p><p>In the last post I had discussed how we are using product flavors to release different versions of the code base with minor changes. It had helped us serve different clients with different requirements.
In this post I would share how we release multiple split libraries and have interdependencies similar to how Google releases play-services or appcompat libraries. It seems easy till the publishing day, until it is not! The problem with inter-dependency is maven does not add the version number in the pom file for local module dependencies.</p>

<p><img src="/assets/images/multi_library.png" alt="Dependency Tree: Release Libraries are public libraries which are released using Maven." /></p>

<h2 id="problem">Problem</h2>

<p>The problem arises when you try to release the super-library and its pom file includes an <code class="highlighter-rouge">unspecified</code> version number for the core-library in the dependency node.</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="cp">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="nt">&lt;project</span> <span class="na">xsi:schemaLocation=</span><span class="s">"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd"</span> <span class="na">xmlns=</span><span class="s">"http://maven.apache.org/POM/4.0.0"</span>
    <span class="na">xmlns:xsi=</span><span class="s">"http://www.w3.org/2001/XMLSchema-instance"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;modelVersion&gt;</span>4.0.0<span class="nt">&lt;/modelVersion&gt;</span>
  <span class="nt">&lt;groupId&gt;</span>lib-groupId<span class="nt">&lt;/groupId&gt;</span>
  <span class="nt">&lt;artifactId&gt;</span>lib-artifactId<span class="nt">&lt;/artifactId&gt;</span>
  <span class="nt">&lt;version&gt;</span>0.0.1<span class="nt">&lt;/version&gt;</span>
  <span class="nt">&lt;packaging&gt;</span>aar<span class="nt">&lt;/packaging&gt;</span>
  <span class="nt">&lt;dependencies&gt;</span>
    <span class="nt">&lt;dependency&gt;</span>
      <span class="nt">&lt;groupId&gt;</span>com.android.support<span class="nt">&lt;/groupId&gt;</span>
      <span class="nt">&lt;artifactId&gt;</span>appcompat-v7<span class="nt">&lt;/artifactId&gt;</span>
      <span class="nt">&lt;version&gt;</span>25.1.0<span class="nt">&lt;/version&gt;</span>
      <span class="nt">&lt;scope&gt;</span>compile<span class="nt">&lt;/scope&gt;</span>
    <span class="nt">&lt;/dependency&gt;</span>
    <span class="c">&lt;!-- Highlighted --&gt;</span>
    <span class="nt">&lt;dependency&gt;</span>
      <span class="nt">&lt;groupId&gt;</span>MultiLibrary<span class="nt">&lt;/groupId&gt;</span>
      <span class="nt">&lt;artifactId&gt;</span>core-library<span class="nt">&lt;/artifactId&gt;</span>
      <span class="nt">&lt;version&gt;</span>unspecified<span class="nt">&lt;/version&gt;</span>
      <span class="nt">&lt;scope&gt;</span>compile<span class="nt">&lt;/scope&gt;</span>
    <span class="nt">&lt;/dependency&gt;</span>
    <span class="c">&lt;!-- Highlighted --&gt;</span>
  <span class="nt">&lt;/dependencies&gt;</span>
<span class="nt">&lt;/project&gt;</span>
</code></pre>
</div>

<h3 id="highlighted-above">Highlighted above:</h3>
<ul>
  <li><strong>groupId</strong> is the rootProject of the library. Here the repo name MultiLibrary.</li>
  <li><strong>version</strong> is <code class="highlighter-rouge">unspecified</code></li>
</ul>

<p>When the client adds it in the their dependencies list, it wont compile throwing an error:</p>

<blockquote>
  <p>Failed to resolve: MultiLibrary.core-library:unspecified</p>
</blockquote>

<h2 id="solution">Solution</h2>

<p>We can inject a function just after pom evaluation is done. We would go through each dependency added in the pom file and edit the particular dependency node if its version is <code class="highlighter-rouge">unspecified</code>. You should check for both, <code class="highlighter-rouge">groupId</code> and <code class="highlighter-rouge">version</code>.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>uploadArchives {
    repositories {
        mavenDeployer {
            repository(url: "file://${buildDir}/outputs/maven")
            pom.groupId = GROUP
            pom.artifactId = ARTIFACT_ID
            pom.version = VERSION
            pom.whenConfigured { pom -&gt;
                println("Current Dependencies ${pom.dependencies}")
                pom.dependencies.each { dep -&gt;
                    println("Processing ${dep}")
                    if (dep.getVersion() == "unspecified" &amp;&amp; dep.getGroupId() == rootProjectDir) {
                        println("Updating Dependencies")
                        dep.setGroupId(GROUP)
                        dep.setVersion(VERSION)
                        println("Updated ${dep}")
                    }
                }
            }
        }
    }
}
</code></pre>
</div>

<p>Now the <code class="highlighter-rouge">core-library</code> dependency in the pom file looks like:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>&lt;dependency&gt;
  &lt;groupId&gt;lib-groupId&lt;/groupId&gt;
  &lt;artifactId&gt;core-library&lt;/artifactId&gt;
  &lt;version&gt;0.0.1&lt;/version&gt;
  &lt;scope&gt;compile&lt;/scope&gt;
&lt;/dependency&gt;
</code></pre>
</div>

<p>Now the dependency is release ready and the client can integrate the super library. Also the sub libraries can be released as separate modules.</p>

<hr />

<p>This post originally appear <a href="https://android.jlelse.eu/releasing-multi-module-android-library-in-gradle-7286cd667b4b">here</a> on Medium</p>
</p>
	</div>
</section>

</div>
  <!-- Footer -->
	<footer id="footer">
		<div class="inner">
			<ul class="icons">
				
				<li><a href="mailto:sahildave1991@gmail.com" class="icon alt fa-envelope" target="_blank"><span class="label">E-Mail</span></a></li>
				
				
				<li><a href="https://github.com/sahildave/" class="icon alt fa-github" target="_blank"><span class="label">GitHub</span></a></li>
				
				
				<li><a href="https://twitter.com/sahildave1991" class="icon alt fa-twitter" target="_blank"><span class="label">Twitter</span></a></li>
				
				
				
				
				<li><a href="https://www.linkedin.com/in/sahildave1991/" class="icon alt fa-linkedin" target="_blank"><span class="label">LinkedIn</span></a></li>
				
				
			</ul>
		</div>
	</footer>
</div>

<!-- Scripts -->
	<script src="/assets/js/jquery.min.js"></script>
	<script src="/assets/js/jquery.scrolly.min.js"></script>
	<script src="/assets/js/jquery.scrollex.min.js"></script>
	<script src="/assets/js/skel.min.js"></script>
	<script src="/assets/js/util.js"></script>
	<!--[if lte IE 8]><script src="/assets/js/ie/respond.min.js"></script><![endif]-->
	<script src="/assets/js/main.js"></script>


</body>

</html>
